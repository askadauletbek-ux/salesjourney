{% extends "base.html" %}
{% set title = "Dashboard ‚Äî Sales Journey" %}

{% block content %}

<div x-data="gameDashboard()" x-init="initDashboard()" class="relative min-h-[80vh]">

  <div class="mb-8 flex items-center justify-between p-6 rounded-3xl border border-white/5 bg-white/5 backdrop-blur-md animate-fade-in">
      <div class="flex items-center gap-5">
          <div class="relative group cursor-pointer" @click="showProfileModal = true">
              <template x-if="userHasAvatar">
                  <img :src="'/api/user/avatar/' + userId" class="w-16 h-16 rounded-2xl object-cover border-2 border-violet-500/50 shadow-lg shadow-violet-500/20">
              </template>
              <template x-if="!userHasAvatar">
                  <div class="w-16 h-16 rounded-2xl bg-violet-600 grid place-items-center text-2xl font-black text-black shadow-lg shadow-violet-500/20" x-text="stats.username[0].toUpperCase()"></div>
              </template>

              <div class="absolute inset-0 bg-black/40 rounded-2xl opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                  <i class="fa-solid fa-camera text-white text-sm"></i>
              </div>
          </div>
          <div>
              <h2 class="text-xl font-black text-white" x-text="stats.username"></h2>
              <p class="text-[10px] text-[color:var(--sj-muted)] font-bold uppercase tracking-[0.2em]" x-text="userRoleLabel"></p>
          </div>
      </div>

      <button @click="showProfileModal = true" class="w-12 h-12 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-all text-white/40 hover:text-white flex items-center justify-center">
          <i class="fa-solid fa-user-pen"></i>
      </button>
  </div>

  <div x-show="showProfileModal"
       x-transition.opacity
       class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm"
       style="display: none;">
      <div class="w-full max-w-md bg-[#0f121d] border border-white/10 rounded-[40px] p-8 shadow-2xl relative" @click.away="showProfileModal = false">
          <h3 class="text-2xl font-black text-white mb-6 tracking-tight">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>

          <div class="space-y-6">
              <div>
                  <label class="text-[10px] font-black uppercase text-white/30 tracking-widest block mb-2">–ò–º—è –≤ —Å–∏—Å—Ç–µ–º–µ</label>
                  <input type="text" x-model="editName" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-white focus:outline-none focus:border-violet-500/50 transition-all">
              </div>

              <div>
                  <label class="text-[10px] font-black uppercase text-white/30 tracking-widest block mb-2">–ù–æ–≤–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞</label>
                  <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 transition-all">
                      <div class="flex flex-col items-center justify-center pt-5 pb-6">
                          <i class="fa-solid fa-cloud-arrow-up text-violet-400 text-2xl mb-2"></i>
                          <p class="text-xs text-white/40 font-bold" x-text="avatarFile ? avatarFile.name : '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞'"></p>
                      </div>
                      <input type="file" class="hidden" @change="onAvatarSelect" accept="image/*" />
                  </label>
              </div>

              <div class="flex gap-4 pt-4">
                  <button @click="saveProfile"
                          :disabled="isSavingProfile"
                          class="flex-1 py-4 rounded-2xl bg-violet-600 text-black font-black uppercase text-[10px] tracking-widest hover:bg-violet-500 transition-all disabled:opacity-50 flex items-center justify-center gap-2">
                      <i x-show="isSavingProfile" class="fa-solid fa-circle-notch fa-spin"></i>
                      <span x-text="isSavingProfile ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'"></span>
                  </button>
                  <button @click="showProfileModal = false" class="flex-1 py-4 rounded-2xl bg-white/5 text-white font-black uppercase text-[10px] tracking-widest hover:bg-white/10 transition-all border border-white/5">–û—Ç–º–µ–Ω–∞</button>
              </div>
          </div>
      </div>
  </div>

  <div x-show="stories.length > 0" class="mb-10 flex gap-4 overflow-x-auto no-scrollbar py-2 px-1">
      <template x-for="story in stories" :key="story.id">
    <div @click="activeStory = story" class="flex-shrink-0 flex flex-col items-center gap-2 cursor-pointer group">
        <div class="w-16 h-16 rounded-full p-1 bg-gradient-to-tr from-violet-600 via-rose-500 to-amber-500 animate-gradient-xy">
            <div class="w-full h-full rounded-full bg-[#0f121d] flex items-center justify-center border-2 border-[#0f121d] overflow-hidden">
                <template x-if="story.has_avatar">
                    <img :src="'/api/user/avatar/' + story.user_id" class="w-full h-full object-cover">
                </template>
                <template x-if="!story.has_avatar">
                    <div class="w-12 h-12 rounded-full bg-violet-600 grid place-items-center font-black text-black text-lg" x-text="story.username[0].toUpperCase()"></div>
                </template>
            </div>
        </div>
        <span class="text-[9px] font-black uppercase tracking-tighter text-white/40 group-hover:text-white transition-colors" x-text="story.type_label"></span>
    </div>
</template>
  </div>

  <template x-if="activeStory">
      <div class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl" @click.self="activeStory = null">
          <div class="w-full max-w-sm rounded-[40px] bg-gradient-to-b from-violet-600/20 to-transparent border border-white/10 p-10 text-center relative overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-white/20">
                  <div class="h-full bg-white animate-[progress_3s_linear]" @animationend="activeStory = null"></div>
              </div>
              <button @click="activeStory = null" class="absolute top-6 right-6 text-white/40 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>

              <div class="w-24 h-24 rounded-3xl bg-violet-600 mx-auto mb-6 grid place-items-center text-4xl font-black text-black shadow-2xl" x-text="activeStory.username[0].toUpperCase()"></div>
              <h2 class="text-3xl font-black text-white mb-2" x-text="activeStory.username"></h2>
              <div class="inline-block px-4 py-1 rounded-full bg-white/5 border border-white/10 text-violet-400 text-xs font-black uppercase tracking-widest mb-8" x-text="activeStory.type_label"></div>

              <div class="text-6xl font-black text-white tracking-tighter mb-2">
                  <span x-text="activeStory.value"></span><span class="text-2xl ml-1" x-text="activeStory.unit"></span>
              </div>
              <div class="text-[10px] font-black uppercase text-white/20 tracking-[0.2em]">–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ –≤—á–µ—Ä–∞</div>
          </div>
      </div>
  </template>

  <div x-show="stats.squad" x-transition class="mb-8 p-1 rounded-2xl bg-gradient-to-r from-violet-600/20 to-fuchsia-600/20 border border-violet-500/20 relative group">
    <div class="absolute -top-3 -right-3 z-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
         <div class="relative group/tooltip">
             <i class="fa-solid fa-circle-info text-violet-300 bg-[#0f121d] rounded-full p-1 border border-violet-500/50 cursor-help shadow-lg"></i>
             <div class="absolute top-full right-0 mt-2 w-64 p-3 bg-[#0f121d] border border-violet-500/30 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                 <div class="font-bold text-violet-300 mb-1">–û–±—â–∞—è —Ü–µ–ª—å –æ—Ç–¥–µ–ª–∞</div>
                 –≠—Ç–æ —Å—É–º–º–∞ —É—Å–∏–ª–∏–π –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ö–æ–≥–¥–∞ —à–∫–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è, –≤—Å—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∏—Ç –±–æ–Ω—É—Å –æ—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è!
             </div>
         </div>
    </div>

    <div class="bg-[#0f121d] rounded-xl p-4 sm:p-6 relative overflow-hidden">
        <div class="relative z-10">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <div class="text-xs font-bold uppercase tracking-widest text-violet-400 mb-1">Squad Goal</div>
                    <h3 class="text-xl font-bold text-white" x-text="stats.squad ? stats.squad.name : ''"></h3>
                </div>
                <div class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">
                    <span x-text="stats.squad ? stats.squad.percent : 0">0</span>%
                </div>
            </div>
            <div class="h-4 rounded-full bg-white/5 border border-white/5 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-violet-600 via-fuchsia-500 to-white shadow-[0_0_20px_rgba(124,58,237,0.5)] transition-all duration-1000"
                     :style="`width: ${stats.squad ? stats.squad.percent : 0}%`" ></div>
            </div>
            <div class="mt-2 flex justify-between text-xs text-[color:var(--sj-muted)]">
                <span>–°—Ç–∞—Ä—Ç</span>
                <span x-text="stats.squad ? `${stats.squad.current} / ${stats.squad.target}` : ''"></span>
            </div>
        </div>
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-violet-500/20 blur-2xl rounded-full"></div>
    </div>
  </div>

  <div class="mb-8 flex flex-col sm:flex-row sm:items-end justify-between gap-4 animate-fade-in-down">
    <div class="relative group cursor-help">
      <h1 class="text-3xl sm:text-4xl font-black tracking-tight text-white mb-2 flex items-center gap-2">
        –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        <i class="fa-regular fa-circle-question text-lg text-white/20 hover:text-white/60 transition-colors"></i>
      </h1>
      <div class="absolute top-full left-0 mt-2 w-72 p-4 bg-[#101524] border border-white/10 rounded-2xl text-sm text-[color:var(--sj-muted)] shadow-2xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50">
          –ó–¥–µ—Å—å —Ç–≤–æ–π –ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í—ã–±–∏—Ä–∞–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —É—Ç—Ä–æ–º, —Å–ª–µ–¥–∏ –∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑ CRM –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∏–≥—Ä–µ.
      </div>

      <p class="text-base text-[color:var(--sj-muted)]">
        –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.
      </p>
    </div>

    <button @click="forceRefresh()"
            class="p-2 rounded-xl hover:bg-white/5 text-[color:var(--sj-muted)] hover:text-white transition-colors group"
            title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
      <i class="fa-solid fa-rotate-right group-hover:rotate-180 transition-transform duration-500" :class="{'fa-spin': loading || amoLoading}"></i>
    </button>
  </div>

  <div class="mb-10 group relative">
      <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-white flex items-center gap-2">
             <i class="fa-solid fa-chart-line text-blue-400"></i> –ú–æ—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
             <div class="relative group/info ml-2">
                 <i class="fa-solid fa-info-circle text-xs text-blue-500/50 hover:text-blue-400 cursor-help"></i>
                 <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-[#101524] border border-blue-500/30 rounded-xl text-xs text-white shadow-xl opacity-0 group-hover/info:opacity-100 pointer-events-none transition-opacity z-50">
                     –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å AmoCRM. –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∏ –∑–≤–æ–Ω–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –±–æ–ª–µ–µ 10 —Å–µ–∫—É–Ω–¥.
                 </div>
             </div>
          </h2>
          <small class="text-xs font-medium text-[color:var(--sj-muted)] transition-colors"
                 :class="{'text-blue-400': amoLoading, 'text-emerald-400': !amoLoading && amoLinked}">
              <span x-html="amoStatusText"></span>
          </small>
      </div>

      <template x-if="amoLinked">
          <div class="grid md:grid-cols-3 gap-6">
              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-blue-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-phone text-6xl text-blue-400 transform -rotate-12"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                           <i class="fa-solid fa-phone text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">–ó–≤–æ–Ω–∫–∏</span>
                      </div>
                      <div class="text-4xl font-black text-white tracking-tighter" x-text="amoStats.calls">0</div>
                  </div>
              </div>

              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-indigo-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-stopwatch text-6xl text-indigo-400 transform rotate-12"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                           <i class="fa-solid fa-clock text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">–í—Ä–µ–º—è</span>
                      </div>
                      <div class="text-4xl font-black text-white tracking-tighter">
                          <span x-text="amoStats.minutes">0</span> <span class="text-lg text-[color:var(--sj-muted)] font-normal">–º–∏–Ω</span>
                      </div>
                  </div>
              </div>

              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-emerald-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-percent text-6xl text-emerald-400"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                           <i class="fa-solid fa-chart-pie text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
                      </div>
                      <div class="text-4xl font-black text-emerald-400 tracking-tighter">
                          <span x-text="amoStats.conversion">0</span>%
                      </div>
                  </div>
              </div>
          </div>
      </template>

      <template x-if="!amoLinked">
          <div class="p-6 rounded-3xl border border-orange-500/20 bg-orange-500/5 flex items-start sm:items-center gap-4">
              <div class="w-12 h-12 rounded-xl bg-orange-500/20 flex-shrink-0 flex items-center justify-center text-orange-500 text-xl">
                  <i class="fa-solid fa-link-slash"></i>
              </div>
              <div>
                  <h3 class="text-lg font-bold text-orange-200">–ù–µ—Ç —Å–≤—è–∑–∏ —Å AmoCRM</h3>
                  <p class="text-sm text-orange-200/60">–ü–æ–ø—Ä–æ—Å–∏—Ç–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —Å–≤—è–∑–∞—Ç—å –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç —Å CRM —Å–∏—Å—Ç–µ–º–æ–π, —á—Ç–æ–±—ã –∑–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</p>
              </div>
          </div>
      </template>
  </div>

  <div class="grid md:grid-cols-3 gap-6 mb-10">

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(124,58,237,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-crown text-8xl text-white transform rotate-12 group-hover:scale-110 transition-transform"></i>
          </div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-[#0f121d] border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-violet-400 mb-1">–û–ø—ã—Ç (XP)</div>
                  –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: 10% –æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–∏–Ω–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–≤–æ–π —Å—Ç–∞—Ç—É—Å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 flex flex-col h-full justify-between">
         <div>
           <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-violet-500/20 flex items-center justify-center text-violet-400">
                <i class="fa-solid fa-star text-sm"></i>
              </div>
              <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">–£—Ä–æ–≤–µ–Ω—å</span>
           </div>
           <div class="text-5xl font-black text-white tracking-tighter">
             <span x-text="stats.level">1</span>
           </div>
         </div>
         <div class="mt-6">
           <div class="flex justify-between text-xs font-semibold text-[color:var(--sj-muted)] mb-2">
             <span>XP –ü—Ä–æ–≥—Ä–µ—Å—Å</span>
             <span x-text="`${stats.xp % 1000} / 1000`">0 / 1000</span>
           </div>
           <div class="h-2.5 rounded-full bg-white/5 border border-white/5 overflow-hidden">
             <div class="h-full bg-gradient-to-r from-violet-600 to-fuchsia-500 shadow-[0_0_10px_rgba(124,58,237,0.5)] transition-all duration-1000"
                  :style="`width: ${(stats.xp % 1000) / 10}%`"></div>
           </div>
         </div>
       </div>
    </div>

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(251,191,36,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute -bottom-4 -right-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-coins text-9xl text-[color:var(--sj-amber)] transform -rotate-12"></i>
          </div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-[#0f121d] border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-[color:var(--sj-amber)] mb-1">–ö–æ–∏–Ω—ã (Coins)</div>
                  –¢–≤–æ—è –≤–∞–ª—é—Ç–∞. –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∑–∞ –∑–≤–æ–Ω–∫–∏ –∏ –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏. –¢—Ä–∞—Ç—å –∏—Ö –≤ –ú–∞–≥–∞–∑–∏–Ω–µ –Ω–∞ –ø—Ä–∏–∑—ã –∏ –±–æ–∫—Å—ã.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 flex flex-col h-full justify-between">
         <div>
           <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center text-[color:var(--sj-amber)]">
                <i class="fa-solid fa-wallet text-sm"></i>
              </div>
              <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">–ë–∞–ª–∞–Ω—Å</span>
           </div>
           <div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-500 tracking-tighter"
                x-text="stats.coins">
             0
           </div>
         </div>
         <a href="/shop" class="mt-6 inline-flex items-center justify-center w-full py-3 rounded-xl bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/20 text-[color:var(--sj-amber)] font-bold transition-all group-hover:translate-x-1">
           –í –º–∞–≥–∞–∑–∏–Ω <i class="fa-solid fa-arrow-right ml-2"></i>
         </a>
       </div>
    </div>

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(251,113,133,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-rose-500/20 blur-[60px] rounded-full"></div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-black/90 border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-[color:var(--sj-rose)] mb-1">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</div>
                  –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –Ω–∏ –¥–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏! –ï—Å–ª–∏ —Å–µ—Ä–∏—è –±–æ–ª—å—à–µ 3 –¥–Ω–µ–π, —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å <span class="text-emerald-400 font-bold">+5% –∫–æ–∏–Ω–æ–≤</span> –∑–∞ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 text-center flex flex-col items-center justify-center h-full">
         <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-rose-500/20 to-orange-500/20 border border-rose-500/30 flex items-center justify-center mb-3 shadow-[0_0_20px_rgba(244,63,94,0.2)] group-hover:scale-110 transition-transform duration-500">
           <i class="fa-solid fa-fire text-3xl text-[color:var(--sj-rose)] animate-pulse"></i>
         </div>
         <div class="text-4xl font-black text-white mb-1">
           <span x-text="stats.streak">0</span> –¥–Ω–µ–π
         </div>
         <div class="text-xs font-bold uppercase tracking-widest text-[color:var(--sj-muted)]">–°–µ—Ä–∏—è –ø–æ–±–µ–¥</div>

         <div x-show="stats.streak > 3" class="mt-2 px-2 py-0.5 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-[10px] text-emerald-400 font-bold">
             +5% –ë–û–ù–£–° –ê–ö–¢–ò–í–ï–ù
         </div>
       </div>
    </div>
  </div>

  <div x-show="currentBuff" x-transition class="mb-10">
      <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
         <i class="fa-solid fa-chess-knight text-violet-400"></i> –ê–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
         <div class="relative group/info ml-2">
             <i class="fa-solid fa-info-circle text-xs text-white/30 hover:text-white cursor-help"></i>
             <div class="absolute bottom-full left-0 mb-2 w-64 p-3 bg-[#101524] border border-white/20 rounded-xl text-xs text-white shadow-xl opacity-0 group-hover/info:opacity-100 pointer-events-none transition-opacity z-50">
                 –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ –ø–æ–ª—É–Ω–æ—á–∏. –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ (x1.5, x0.5) –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ AmoCRM.
             </div>
         </div>
      </h2>
      <div class="p-6 rounded-3xl border border-yellow-500/30 bg-yellow-500/5 relative overflow-hidden flex items-center gap-6">
          <div class="w-16 h-16 rounded-2xl bg-yellow-500/20 flex items-center justify-center text-3xl">
              <i class="fa-solid fa-shark text-yellow-400" x-show="currentBuff === 'SHARK'"></i>
              <i class="fa-solid fa-hammer text-yellow-400" x-show="currentBuff === 'WOODPECKER'"></i>
              <i class="fa-solid fa-yin-yang text-yellow-400" x-show="currentBuff === 'ZEN'"></i>
          </div>
          <div>
              <div class="text-yellow-400 font-bold text-lg tracking-wide" x-text="currentBuff"></div>
              <div class="text-white/60 text-sm">–í–∞—à–∏ –±–æ–Ω—É—Å—ã –∞–∫—Ç–∏–≤–Ω—ã –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è.</div>
          </div>
      </div>
  </div>

  <div x-show="!loading && currentBuff === null"
       x-transition.opacity.duration.500ms
       class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#070b16]/95 backdrop-blur-md" style="display: none;">

       <div class="w-full max-w-5xl animate-bounce-in">
           <div class="text-center mb-8 relative">
               <h1 class="text-3xl md:text-5xl font-black text-white mb-3">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é</h1>
               <p class="text-lg text-[color:var(--sj-muted)] flex items-center justify-center gap-2">
                   –ö–∞–∫ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–±–µ–∂–¥–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?
                   <span class="group relative cursor-help">
                       <i class="fa-regular fa-circle-question text-white/40 hover:text-white/80 text-sm"></i>
                       <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-[#101524] border border-white/10 rounded-xl text-xs text-left text-[color:var(--sj-muted)] shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-[110]">
                           <strong class="text-white block mb-1">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ä–∏—Ç—É–∞–ª</strong>
                           –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ 00:00. –û–Ω–∞ —É–º–Ω–æ–∂–∞–µ—Ç –±–∞–ª–ª—ã –∑–∞ –æ–¥–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—è –∏ —É–º–µ–Ω—å—à–∞–µ—Ç –∑–∞ –¥—Ä—É–≥–∏–µ. –í—ã–±–∏—Ä–∞–π—Ç–µ —Å —É–º–æ–º, –∏—Å—Ö–æ–¥—è –∏–∑ –ø–ª–∞–Ω–æ–≤ –Ω–∞ –¥–µ–Ω—å!
                       </span>
                   </span>
               </p>
           </div>

           <div class="grid lg:grid-cols-3 gap-6">
                <button @click="chooseBuff('SHARK')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-indigo-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-indigo-500/20 flex items-center justify-center mb-4 text-3xl text-indigo-400">
                        <i class="fa-solid fa-shark"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">–ê–∫—É–ª–∞</h3>
                    <p class="text-indigo-200/60 text-sm mb-4">–û—Ö–æ—Ç–∞ –Ω–∞ –∫—Ä—É–ø–Ω—É—é –¥–æ–±—ã—á—É.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">–ü—Ä–æ–¥–∞–∂–∏</span> <span class="text-emerald-400 font-bold">x1.5</span></div>
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">–ó–≤–æ–Ω–∫–∏</span> <span class="text-rose-400 font-bold">x0.5</span></div>
                    </div>
                </button>

                <button @click="chooseBuff('WOODPECKER')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-rose-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-rose-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-rose-500/20 flex items-center justify-center mb-4 text-3xl text-rose-400">
                        <i class="fa-solid fa-hammer"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">–î—è—Ç–µ–ª</h3>
                    <p class="text-rose-200/60 text-sm mb-4">–£–ø–æ—Ä—Å—Ç–≤–æ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">–ó–≤–æ–Ω–∫–∏</span> <span class="text-emerald-400 font-bold">x1.5</span></div>
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">–ü—Ä–æ–¥–∞–∂–∏</span> <span class="text-rose-400 font-bold">x0.5</span></div>
                    </div>
                </button>

                <button @click="chooseBuff('ZEN')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-emerald-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-emerald-500/20 flex items-center justify-center mb-4 text-3xl text-emerald-400">
                        <i class="fa-solid fa-yin-yang"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">–î–∑–µ–Ω</h3>
                    <p class="text-emerald-200/60 text-sm mb-4">–ë–∞–ª–∞–Ω—Å –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</span> <span class="text-white font-bold">x1.0</span></div>
                        <div class="p-2 opacity-0">Spacer</div>
                    </div>
                </button>
           </div>
       </div>
  </div>

  <div x-show="loading"
       x-transition.opacity
       class="absolute inset-0 bg-[#070b16]/50 backdrop-blur-sm z-50 flex items-center justify-center rounded-3xl" style="display: none;">
    <div class="flex flex-col items-center">
      <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[color:var(--sj-primary)]"></i>
      <span class="mt-2 text-sm font-semibold text-white">–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é...</span>
    </div>
  </div>

  <div class="mt-16 max-w-4xl mx-auto px-4">
      <style>
          .feed-timeline { position: relative; padding-left: 2.5rem; }
          .feed-timeline::before { content: ''; position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--sj-primary) 0%, transparent 100%); opacity: 0.15; }
          .feed-node { position: absolute; left: 0.15rem; width: 1.25rem; height: 1.25rem; background: #0f121d; border: 3px solid var(--sj-primary); border-radius: 50%; z-index: 10; margin-top: 1.5rem; box-shadow: 0 0 15px var(--sj-primary); }
          .smart-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 30px; backdrop-filter: blur(12px); overflow: hidden; transition: all 0.3s; margin-bottom: 2.5rem; }
          .record-badge { background: linear-gradient(90deg, rgba(34,211,238,0.1) 0%, transparent 100%); border: 1px solid rgba(34,211,238,0.2); border-radius: 20px; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
          .smart-img { width: 100%; max-height: 500px; object-fit: cover; margin-top: 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: block; }
      </style>

      <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-black text-white tracking-tight flex items-center gap-3">
             <i class="fa-solid fa-fire-pulse text-amber-500"></i> –ñ–∏–∑–Ω—å –∫–æ–º–ø–∞–Ω–∏–∏
          </h2>
          <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/30">Live Updates</span>
      </div>

      <div class="feed-timeline">
          <template x-for="item in feedItems" :key="item.id">
              <div class="relative">
                  <div class="feed-node"></div>

                  <template x-if="item.type === 'system'">
                      <div class="record-badge">
                          <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center text-cyan-400 border border-cyan-500/30">
                              <i class="fa-solid fa-trophy"></i>
                          </div>
                          <div class="flex-1 min-w-0">
                              <p class="font-bold text-sm text-white/90" x-text="item.message"></p>
                              <div class="text-[9px] text-white/30 font-black uppercase mt-1" x-text="formatDate(item.created_at)"></div>
                          </div>
                      </div>
                  </template>

                  <template x-if="item.type === 'post'">
                      <div class="smart-card">
                          <div class="p-6">
                              <div class="flex items-center justify-between mb-4">
                                  <div class="flex items-center gap-3">
                                      <div class="w-10 h-10 rounded-xl bg-violet-600 flex items-center justify-center text-black font-black" x-text="item.author[0].toUpperCase()"></div>
                                      <div>
                                          <div class="font-black text-sm text-white" x-text="item.author"></div>
                                          <div class="text-[10px] text-white/40" x-text="formatDate(item.created_at)"></div>
                                      </div>
                                  </div>
                              </div>
                              <div class="text-white/80 leading-relaxed" x-text="item.content"></div>

                              <template x-if="item.image_url && item.image_url !== ''">
                                  <div class="mt-4 rounded-2xl overflow-hidden bg-black/40 border border-white/5">
                                      <img :src="item.image_url"
                                           class="smart-img"
                                           loading="lazy"
                                           @error="console.log('Image failed:', item.image_url)">
                                  </div>
                              </template>
                          </div>

                          <div class="px-6 py-4 flex items-center gap-6 bg-white/5 border-t border-white/5">
                              <button @click="likePost(item)" class="flex items-center gap-2 text-sm font-bold transition-colors" :class="item.is_liked ? 'text-rose-500' : 'text-white/40 hover:text-white'">
                                  <i :class="item.is_liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                                  <span x-text="item.likes_count"></span>
                              </button>
                              <button @click="item.open = !item.open" class="flex items-center gap-2 text-white/40 hover:text-white text-sm font-bold transition-colors">
                                  <i class="fa-regular fa-comment"></i>
                                  <span x-text="item.comments.length"></span>
                              </button>
                          </div>

                          <div x-show="item.open" x-transition class="bg-black/20 p-6 border-t border-white/5">
                              <div class="space-y-4 mb-4">
                                  <template x-for="c in item.comments">
                                      <div class="flex gap-3 text-xs">
                                          <div class="font-black text-violet-400" x-text="c.username + ':'"></div>
                                          <div class="text-white/70" x-text="c.text"></div>
                                      </div>
                                  </template>
                              </div>
                              <input x-model="item.tempComm" @keyup.enter="sendComment(item)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-xs text-white focus:outline-none focus:border-violet-500/50" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
                          </div>
                      </div>
                  </template>
              </div>
          </template>
      </div>
  </div>

  <div x-show="showRewardModal"
       x-transition.opacity.duration.500ms
       class="fixed inset-0 z-[500] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md"
       style="display: none;">

      <div class="w-full max-w-lg bg-[#0f121d] border-2 border-amber-500/30 rounded-[40px] p-8 shadow-[0_0_50px_rgba(245,158,11,0.2)] relative text-center animate-bounce-in"
           @click.away="showRewardModal = false">

          <div class="absolute -top-12 left-1/2 -translate-x-1/2 w-24 h-24 bg-gradient-to-br from-amber-400 to-orange-600 rounded-3xl rotate-12 flex items-center justify-center shadow-2xl">
              <i class="fa-solid fa-gift text-4xl text-black -rotate-12"></i>
          </div>

          <div class="mt-8 mb-6">
              <h2 class="text-3xl font-black text-white mb-2 tracking-tight">–¢–≤–æ–∏ —É—Å–ø–µ—Ö–∏ –∑–∞ –≤—á–µ—Ä–∞!</h2>
              <p class="text-[color:var(--sj-muted)] text-sm font-medium uppercase tracking-widest">–ò—Ç–æ–≥–∏ –¥–Ω—è –∑–∞ <span x-text="dailyReward?.date"></span></p>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-8">
              <div class="bg-amber-500/5 border border-amber-500/20 rounded-3xl p-5 group hover:bg-amber-500/10 transition-colors">
                  <div class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1">–ü–æ–ª—É—á–µ–Ω–æ</div>
                  <div class="text-3xl font-black text-white" x-text="'+' + dailyReward?.coins"></div>
                  <div class="text-[10px] font-bold text-amber-500/50 uppercase">–ö–æ–∏–Ω–æ–≤</div>
              </div>
              <div class="bg-violet-500/5 border border-violet-500/20 rounded-3xl p-5 group hover:bg-violet-500/10 transition-colors">
                  <div class="text-[10px] font-black text-violet-400 uppercase tracking-widest mb-1">–û–ø—ã—Ç</div>
                  <div class="text-3xl font-black text-white" x-text="'+' + dailyReward?.xp"></div>
                  <div class="text-[10px] font-bold text-violet-400/50 uppercase">XP</div>
              </div>
          </div>

          <div class="bg-white/5 rounded-3xl p-6 mb-8 text-left space-y-3">
              <div class="flex justify-between items-center text-sm">
                  <span class="text-white/40 font-bold uppercase tracking-tighter">–ó–≤–æ–Ω–∫–∏</span>
                  <span class="text-white font-black" x-text="dailyReward?.calls"></span>
              </div>
              <div class="flex justify-between items-center text-sm">
                  <span class="text-white/40 font-bold uppercase tracking-tighter">–ú–∏–Ω—É—Ç—ã</span>
                  <span class="text-white font-black" x-text="dailyReward?.mins"></span>
              </div>
              <div class="flex justify-between items-center text-sm">
                  <span class="text-white/40 font-bold uppercase tracking-tighter">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
                  <span class="text-emerald-400 font-black" x-text="dailyReward?.conv + '%'"></span>
              </div>
          </div>

          <template x-if="suggestions.length > 0">
              <div class="mb-8">
                  <h4 class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em] mb-4">–ù–∞ —á—Ç–æ —Ö–≤–∞—Ç–∏—Ç –∫–æ–∏–Ω–æ–≤:</h4>
                  <div class="flex flex-wrap justify-center gap-2">
                      <template x-for="item in suggestions" :key="item.id">
                          <a href="/shop" class="px-4 py-2 bg-white/5 border border-white/10 rounded-xl text-xs font-bold text-white hover:bg-white/10 transition-all flex items-center gap-2">
                              <span x-text="item.name"></span>
                              <span class="text-amber-500" x-text="item.price + 'üí∞'"></span>
                          </a>
                      </template>
                  </div>
              </div>
          </template>

          <button @click="showRewardModal = false" class="w-full py-5 rounded-2xl bg-amber-500 text-black font-black uppercase text-xs tracking-[0.2em] hover:bg-amber-400 transition-all shadow-lg shadow-amber-500/20">
              –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
      </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function gameDashboard() {
    return {
      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ—Ñ–∏–ª—è
      userId: {{ current_user.id }},
      userHasAvatar: {{ 'true' if current_user.avatar_data else 'false' }},
      userRoleLabel: "{{ current_user.role.value }}",
      showProfileModal: false,
      isSavingProfile: false,
      editName: "{{ current_user.username or '' }}",
      avatarFile: null,

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
      loading: false,
      currentBuff: null,
      stats: {
        username: "{{ current_user.username or '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' }}",
        coins: {{ user.gamification_profile.coins or 0 }},
        xp: {{ user.gamification_profile.xp or 0 }},
        streak: {{ user.gamification_profile.current_streak or 0 }},
        level: {{ (user.gamification_profile.xp // 1000) + 1 }},
        squad: null
      },

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã
      showRewardModal: {{ 'true' if daily_reward else 'false' }},
      dailyReward: {{ daily_reward | tojson if daily_reward else 'null' }},
      suggestions: {{ suggestions | tojson if suggestions else '[]' }},

      onAvatarSelect(e) {
          this.avatarFile = e.target.files[0];
      },

      async saveProfile() {
          this.isSavingProfile = true;
          const fd = new FormData();
          fd.append('username', this.editName);
          if (this.avatarFile) fd.append('avatar', this.avatarFile);

          try {
              const r = await fetch('/api/user/profile/update', { method: 'POST', body: fd });
              if (r.ok) {
                  this.stats.username = this.editName;
                  if (this.avatarFile) {
                      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫
                      location.reload();
                  } else {
                      this.showProfileModal = false;
                      Alpine.store('toasts').push({title:'–£—Å–ø–µ—à–Ω–æ', text:'–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', tone:'ok'});
                  }
              }
          } catch(e) {
              console.error(e);
          } finally {
              this.isSavingProfile = false;
          }
      },

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ AmoCRM
      amoLinked: {{ 'true' if is_amo_linked else 'false' }},
      amoLoading: false,
      amoStats: {
          calls: {{ amo_stat.calls_count or 0 }},
          minutes: {{ amo_stat.minutes_talked or 0 }},
          conversion: {{ amo_stat.conversion or 0 }}
      },
      amoStatusText: '{% if amo_stat.updated_at %}<i class="far fa-clock me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ amo_stat.updated_at.strftime('%H:%M') }}{% else %}–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã{% endif %}',

      initDashboard() {
        this.fetchStatus();
        this.loadFeed(); // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
        this.loadStories(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ—Ä–∏—Å
        if (this.amoLinked) {
            this.syncAmoStats();
        }

        // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç—ã
        const s = io();
        s.on('new_feed_item', () => {
             this.loadFeed();
        });
      },

      // --- –°—Ç–æ—Ä–∏—Å ---
      stories: [],
      activeStory: null,
      async loadStories() {
          try {
              const r = await fetch('/api/feed/stories');
              if (r.ok) this.stories = await r.json();
          } catch(e) { console.error("Stories error", e); }
      },

      // --- –õ–µ–Ω—Ç–∞ ---
      feedItems: [],
      async loadFeed() {
          try {
              const r = await fetch('/api/feed/list');
              if (!r.ok) return;
              const data = await r.json();

              // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è Alpine
              this.feedItems = data.map(x => ({
                  ...x,
                  open: false,
                  tempComm: '',
                  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–∞–∂–µ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                  comments: x.comments || []
              }));
          } catch(e) {
              console.error("Feed error", e);
          }
      },
      async likePost(i) {
          const r = await fetch(`/api/feed/post/${i.id}/like`, {method: 'POST'});
          const d = await r.json();
          i.is_liked = d.status === 'liked';
          i.likes_count += (i.is_liked ? 1 : -1);
      },

      async sendComment(i) {
          if(!i.tempComm) return;
          const r = await fetch(`/api/feed/post/${i.id}/comment`, {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({text: i.tempComm})
          });
          const d = await r.json();
          i.comments.push({username: d.username, text: i.tempComm});
          i.tempComm = '';
      },

      formatDate(s) { return new Date(s).toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'}); },

      forceRefresh() {
          this.fetchStatus();
          if(this.amoLinked) this.syncAmoStats();
      },

      // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã ---
      async fetchStatus() {
        try {
          const res = await fetch('/api/game/status');
          if (res.ok) {
            const data = await res.json();
            this.stats.coins = data.coins;
            this.stats.xp = data.xp;
            this.stats.streak = data.streak;
            this.stats.level = data.level;
            this.stats.squad = data.squad;
            this.currentBuff = data.today_buff;
          }
        } catch (e) {
          console.error("Failed to fetch status", e);
        }
      },

      async chooseBuff(type) {
        if (this.currentBuff) return;
        this.loading = true;
        try {
          const response = await fetch('/api/game/buff/choose', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ buff_type: type })
          });
          const result = await response.json();

          if (response.ok) {
            this.currentBuff = type;
            Alpine.store('toasts').push({
              title: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!',
              text: result.message,
              tone: 'ok',
              icon: 'fa-solid fa-check-double'
            });
            if (result.streak !== undefined) this.stats.streak = result.streak;
          } else {
            Alpine.store('toasts').push({title: '–û—à–∏–±–∫–∞', text: result.error, tone: 'err'});
          }
        } catch (e) {
          Alpine.store('toasts').push({title: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', text: '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', tone: 'err'});
        } finally {
            this.loading = false;
        }
      },

      // --- –õ–æ–≥–∏–∫–∞ AmoCRM ---
      async syncAmoStats() {
          this.amoLoading = true;
          this.amoStatusText = '<i class="fas fa-sync fa-spin me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';

          try {
              const response = await fetch('/api/partners/company/my/sync_stats', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'}
              });
              const data = await response.json();

              if (data.linked) {
                  // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–µ–ª
                  this.animateValue('calls', this.amoStats.calls, data.calls);
                  this.animateValue('minutes', this.amoStats.minutes, data.minutes);
                  this.animateValue('conversion', this.amoStats.conversion, data.conversion);

                  this.amoStatusText = '<i class="fas fa-check-circle me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ç–æ–ª—å–∫–æ —á—Ç–æ';
              }
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ AmoCRM:', error);
              this.amoStatusText = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
          } finally {
              this.amoLoading = false;
          }
      },

      animateValue(key, start, end) {
          if (start === end) return;
          let current = start;
          const step = (end - start) / 20; // 20 —à–∞–≥–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
          const timer = setInterval(() => {
              current += step;
              if ((step > 0 && current >= end) || (step < 0 && current <= end)) {
                  this.amoStats[key] = end;
                  clearInterval(timer);
              } else {
                  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞ –¥–ª—è –¥—Ä–æ–±–Ω—ã—Ö –∏–ª–∏ –¥–æ —Ü–µ–ª–æ–≥–æ
                  this.amoStats[key] = Number.isInteger(end) ? Math.round(current) : parseFloat(current.toFixed(1));
              }
          }, 30);
      }
    }
  }
</script>
{% endblock %}