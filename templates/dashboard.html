{% extends "base.html" %}
{% set title = "Dashboard — Sales Journey" %}

{% block content %}

<div x-data="gameDashboard()" x-init="initDashboard()" class="relative min-h-[80vh]">

  <div class="mb-8 flex items-center justify-between p-6 rounded-3xl border border-white/5 bg-white/5 backdrop-blur-md animate-fade-in">
      <div class="flex items-center gap-5">
          <div class="relative group cursor-pointer" @click="showProfileModal = true">
              <template x-if="userHasAvatar">
                  <img :src="'/api/user/avatar/' + userId" class="w-16 h-16 rounded-2xl object-cover border-2 border-violet-500/50 shadow-lg shadow-violet-500/20">
              </template>
              <template x-if="!userHasAvatar">
                  <div class="w-16 h-16 rounded-2xl bg-violet-600 grid place-items-center text-2xl font-black text-black shadow-lg shadow-violet-500/20" x-text="stats.username[0].toUpperCase()"></div>
              </template>

              <div class="absolute inset-0 bg-black/40 rounded-2xl opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                  <i class="fa-solid fa-camera text-white text-sm"></i>
              </div>
          </div>
          <div>
              <h2 class="text-xl font-black text-white" x-text="stats.username"></h2>
              <p class="text-[10px] text-[color:var(--sj-muted)] font-bold uppercase tracking-[0.2em]" x-text="userRoleLabel"></p>
          </div>
      </div>

      <button @click="showProfileModal = true" class="w-12 h-12 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-all text-white/40 hover:text-white flex items-center justify-center">
          <i class="fa-solid fa-user-pen"></i>
      </button>
  </div>

  <div x-show="showProfileModal"
       x-transition.opacity
       class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm"
       style="display: none;">
      <div class="w-full max-w-md bg-[#0f121d] border border-white/10 rounded-[40px] p-8 shadow-2xl relative" @click.away="showProfileModal = false">
          <h3 class="text-2xl font-black text-white mb-6 tracking-tight">Настройки профиля</h3>

          <div class="space-y-6">
              <div>
                  <label class="text-[10px] font-black uppercase text-white/30 tracking-widest block mb-2">Имя в системе</label>
                  <input type="text" x-model="editName" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-white focus:outline-none focus:border-violet-500/50 transition-all">
              </div>

              <div>
                  <label class="text-[10px] font-black uppercase text-white/30 tracking-widest block mb-2">Новая аватарка</label>
                  <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 transition-all">
                      <div class="flex flex-col items-center justify-center pt-5 pb-6">
                          <i class="fa-solid fa-cloud-arrow-up text-violet-400 text-2xl mb-2"></i>
                          <p class="text-xs text-white/40 font-bold" x-text="avatarFile ? avatarFile.name : 'Нажмите для выбора'"></p>
                      </div>
                      <input type="file" class="hidden" @change="onAvatarSelect" accept="image/*" />
                  </label>
              </div>

              <div class="flex gap-4 pt-4">
                  <button @click="saveProfile"
                          :disabled="isSavingProfile"
                          class="flex-1 py-4 rounded-2xl bg-violet-600 text-black font-black uppercase text-[10px] tracking-widest hover:bg-violet-500 transition-all disabled:opacity-50 flex items-center justify-center gap-2">
                      <i x-show="isSavingProfile" class="fa-solid fa-circle-notch fa-spin"></i>
                      <span x-text="isSavingProfile ? 'Сохранение...' : 'Сохранить'"></span>
                  </button>
                  <button @click="showProfileModal = false" class="flex-1 py-4 rounded-2xl bg-white/5 text-white font-black uppercase text-[10px] tracking-widest hover:bg-white/10 transition-all border border-white/5">Отмена</button>
              </div>
          </div>
      </div>
  </div>

  <div x-show="stories.length > 0" class="mb-10 flex gap-4 overflow-x-auto no-scrollbar py-2 px-1">
      <template x-for="story in stories" :key="story.id">
    <div @click="activeStory = story" class="flex-shrink-0 flex flex-col items-center gap-2 cursor-pointer group">
        <div class="w-16 h-16 rounded-full p-1 bg-gradient-to-tr from-violet-600 via-rose-500 to-amber-500 animate-gradient-xy">
            <div class="w-full h-full rounded-full bg-[#0f121d] flex items-center justify-center border-2 border-[#0f121d] overflow-hidden">
                <template x-if="story.has_avatar">
                    <img :src="'/api/user/avatar/' + story.user_id" class="w-full h-full object-cover">
                </template>
                <template x-if="!story.has_avatar">
                    <div class="w-12 h-12 rounded-full bg-violet-600 grid place-items-center font-black text-black text-lg" x-text="story.username[0].toUpperCase()"></div>
                </template>
            </div>
        </div>
        <span class="text-[9px] font-black uppercase tracking-tighter text-white/40 group-hover:text-white transition-colors" x-text="story.type_label"></span>
    </div>
</template>
  </div>

  <template x-if="activeStory">
      <div class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl" @click.self="activeStory = null">
          <div class="w-full max-w-sm rounded-[40px] bg-gradient-to-b from-violet-600/20 to-transparent border border-white/10 p-10 text-center relative overflow-hidden">
              <div class="absolute top-0 left-0 w-full h-1 bg-white/20">
                  <div class="h-full bg-white animate-[progress_3s_linear]" @animationend="activeStory = null"></div>
              </div>
              <button @click="activeStory = null" class="absolute top-6 right-6 text-white/40 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>

              <div class="w-24 h-24 rounded-3xl bg-violet-600 mx-auto mb-6 grid place-items-center text-4xl font-black text-black shadow-2xl" x-text="activeStory.username[0].toUpperCase()"></div>
              <h2 class="text-3xl font-black text-white mb-2" x-text="activeStory.username"></h2>
              <div class="inline-block px-4 py-1 rounded-full bg-white/5 border border-white/10 text-violet-400 text-xs font-black uppercase tracking-widest mb-8" x-text="activeStory.type_label"></div>

              <div class="text-6xl font-black text-white tracking-tighter mb-2">
                  <span x-text="activeStory.value"></span><span class="text-2xl ml-1" x-text="activeStory.unit"></span>
              </div>
              <div class="text-[10px] font-black uppercase text-white/20 tracking-[0.2em]">Результат за вчера</div>
          </div>
      </div>
  </template>

  <div x-show="stats.squad" x-transition class="mb-8 p-1 rounded-2xl bg-gradient-to-r from-violet-600/20 to-fuchsia-600/20 border border-violet-500/20 relative group">
    <div class="absolute -top-3 -right-3 z-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
         <div class="relative group/tooltip">
             <i class="fa-solid fa-circle-info text-violet-300 bg-[#0f121d] rounded-full p-1 border border-violet-500/50 cursor-help shadow-lg"></i>
             <div class="absolute top-full right-0 mt-2 w-64 p-3 bg-[#0f121d] border border-violet-500/30 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                 <div class="font-bold text-violet-300 mb-1">Общая цель отдела</div>
                 Это сумма усилий всех сотрудников. Когда шкала заполнится, вся команда получит бонус от руководителя!
             </div>
         </div>
    </div>

    <div class="bg-[#0f121d] rounded-xl p-4 sm:p-6 relative overflow-hidden">
        <div class="relative z-10">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <div class="text-xs font-bold uppercase tracking-widest text-violet-400 mb-1">Squad Goal</div>
                    <h3 class="text-xl font-bold text-white" x-text="stats.squad ? stats.squad.name : ''"></h3>
                </div>
                <div class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">
                    <span x-text="stats.squad ? stats.squad.percent : 0">0</span>%
                </div>
            </div>
            <div class="h-4 rounded-full bg-white/5 border border-white/5 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-violet-600 via-fuchsia-500 to-white shadow-[0_0_20px_rgba(124,58,237,0.5)] transition-all duration-1000"
                     :style="`width: ${stats.squad ? stats.squad.percent : 0}%`" ></div>
            </div>
            <div class="mt-2 flex justify-between text-xs text-[color:var(--sj-muted)]">
                <span>Старт</span>
                <span x-text="stats.squad ? `${stats.squad.current} / ${stats.squad.target}` : ''"></span>
            </div>
        </div>
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-violet-500/20 blur-2xl rounded-full"></div>
    </div>
  </div>

  <div class="mb-8 flex flex-col sm:flex-row sm:items-end justify-between gap-4 animate-fade-in-down">
    <div class="relative group cursor-help">
      <h1 class="text-3xl sm:text-4xl font-black tracking-tight text-white mb-2 flex items-center gap-2">
        Центр управления
        <i class="fa-regular fa-circle-question text-lg text-white/20 hover:text-white/60 transition-colors"></i>
      </h1>
      <div class="absolute top-full left-0 mt-2 w-72 p-4 bg-[#101524] border border-white/10 rounded-2xl text-sm text-[color:var(--sj-muted)] shadow-2xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50">
          Здесь твой пульт управления. Выбирай стратегию утром, следи за статистикой из CRM и контролируй свой прогресс в игре.
      </div>

      <p class="text-base text-[color:var(--sj-muted)]">
        Твой прогресс и ежедневные решения.
      </p>
    </div>

    <button @click="forceRefresh()"
            class="p-2 rounded-xl hover:bg-white/5 text-[color:var(--sj-muted)] hover:text-white transition-colors group"
            title="Обновить данные">
      <i class="fa-solid fa-rotate-right group-hover:rotate-180 transition-transform duration-500" :class="{'fa-spin': loading || amoLoading}"></i>
    </button>
  </div>

  <div class="mb-10 group relative">
      <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-white flex items-center gap-2">
             <i class="fa-solid fa-chart-line text-blue-400"></i> Моя эффективность
             <div class="relative group/info ml-2">
                 <i class="fa-solid fa-info-circle text-xs text-blue-500/50 hover:text-blue-400 cursor-help"></i>
                 <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-[#101524] border border-blue-500/30 rounded-xl text-xs text-white shadow-xl opacity-0 group-hover/info:opacity-100 pointer-events-none transition-opacity z-50">
                     Данные синхронизируются с AmoCRM. Учитываются только успешные сделки и звонки длительностью более 10 секунд.
                 </div>
             </div>
          </h2>
          <small class="text-xs font-medium text-[color:var(--sj-muted)] transition-colors"
                 :class="{'text-blue-400': amoLoading, 'text-emerald-400': !amoLoading && amoLinked}">
              <span x-html="amoStatusText"></span>
          </small>
      </div>

      <template x-if="amoLinked">
          <div class="grid md:grid-cols-3 gap-6">
              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-blue-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-phone text-6xl text-blue-400 transform -rotate-12"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                           <i class="fa-solid fa-phone text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">Звонки</span>
                      </div>
                      <div class="text-4xl font-black text-white tracking-tighter" x-text="amoStats.calls">0</div>
                  </div>
              </div>

              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-indigo-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-stopwatch text-6xl text-indigo-400 transform rotate-12"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                           <i class="fa-solid fa-clock text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">Время</span>
                      </div>
                      <div class="text-4xl font-black text-white tracking-tighter">
                          <span x-text="amoStats.minutes">0</span> <span class="text-lg text-[color:var(--sj-muted)] font-normal">мин</span>
                      </div>
                  </div>
              </div>

              <div class="relative overflow-hidden rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] p-6 shadow-lg hover:border-emerald-500/30 transition-colors">
                  <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                      <i class="fa-solid fa-percent text-6xl text-emerald-400"></i>
                  </div>
                  <div class="relative z-10">
                      <div class="flex items-center gap-3 mb-2">
                         <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                           <i class="fa-solid fa-chart-pie text-sm"></i>
                         </div>
                         <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">Конверсия</span>
                      </div>
                      <div class="text-4xl font-black text-emerald-400 tracking-tighter">
                          <span x-text="amoStats.conversion">0</span>%
                      </div>
                  </div>
              </div>
          </div>
      </template>

      <template x-if="!amoLinked">
          <div class="p-6 rounded-3xl border border-orange-500/20 bg-orange-500/5 flex items-start sm:items-center gap-4">
              <div class="w-12 h-12 rounded-xl bg-orange-500/20 flex-shrink-0 flex items-center justify-center text-orange-500 text-xl">
                  <i class="fa-solid fa-link-slash"></i>
              </div>
              <div>
                  <h3 class="text-lg font-bold text-orange-200">Нет связи с AmoCRM</h3>
                  <p class="text-sm text-orange-200/60">Попросите руководителя связать ваш аккаунт с CRM системой, чтобы здесь отображалась ваша статистика.</p>
              </div>
          </div>
      </template>
  </div>

  <div class="grid md:grid-cols-3 gap-6 mb-10">

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(124,58,237,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-crown text-8xl text-white transform rotate-12 group-hover:scale-110 transition-transform"></i>
          </div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-[#0f121d] border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-violet-400 mb-1">Опыт (XP)</div>
                  Начисляется автоматически: 10% от заработанных коинов. Показывает твой статус и активность в компании.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 flex flex-col h-full justify-between">
         <div>
           <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-violet-500/20 flex items-center justify-center text-violet-400">
                <i class="fa-solid fa-star text-sm"></i>
              </div>
              <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">Уровень</span>
           </div>
           <div class="text-5xl font-black text-white tracking-tighter">
             <span x-text="stats.level">1</span>
           </div>
         </div>
         <div class="mt-6">
           <div class="flex justify-between text-xs font-semibold text-[color:var(--sj-muted)] mb-2">
             <span>XP Прогресс</span>
             <span x-text="`${stats.xp % 1000} / 1000`">0 / 1000</span>
           </div>
           <div class="h-2.5 rounded-full bg-white/5 border border-white/5 overflow-hidden">
             <div class="h-full bg-gradient-to-r from-violet-600 to-fuchsia-500 shadow-[0_0_10px_rgba(124,58,237,0.5)] transition-all duration-1000"
                  :style="`width: ${(stats.xp % 1000) / 10}%`"></div>
           </div>
         </div>
       </div>
    </div>

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(251,191,36,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute -bottom-4 -right-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i class="fa-solid fa-coins text-9xl text-[color:var(--sj-amber)] transform -rotate-12"></i>
          </div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-[#0f121d] border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-[color:var(--sj-amber)] mb-1">Коины (Coins)</div>
                  Твоя валюта. Начисляется за звонки и закрытые сделки. Трать их в Магазине на призы и боксы.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 flex flex-col h-full justify-between">
         <div>
           <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center text-[color:var(--sj-amber)]">
                <i class="fa-solid fa-wallet text-sm"></i>
              </div>
              <span class="text-sm font-bold uppercase tracking-wider text-[color:var(--sj-muted)]">Баланс</span>
           </div>
           <div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-500 tracking-tighter"
                x-text="stats.coins">
             0
           </div>
         </div>
         <a href="/shop" class="mt-6 inline-flex items-center justify-center w-full py-3 rounded-xl bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/20 text-[color:var(--sj-amber)] font-bold transition-all group-hover:translate-x-1">
           В магазин <i class="fa-solid fa-arrow-right ml-2"></i>
         </a>
       </div>
    </div>

    <div class="relative group rounded-3xl border border-[color:var(--sj-border)] bg-[#101524] shadow-lg hover:shadow-[0_0_30px_rgba(251,113,133,0.15)] transition-all duration-300">
       <div class="absolute inset-0 overflow-hidden rounded-3xl z-0">
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-rose-500/20 blur-[60px] rounded-full"></div>
       </div>

       <div class="absolute top-4 right-4 z-50 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="relative group/tooltip">
              <i class="fa-regular fa-circle-question text-[color:var(--sj-muted)] hover:text-white cursor-help text-lg"></i>
              <div class="absolute bottom-full right-0 mb-2 w-56 p-3 bg-black/90 border border-white/10 rounded-xl text-xs text-white shadow-2xl pointer-events-none opacity-0 group-hover/tooltip:opacity-100 transition-opacity">
                  <div class="font-bold text-[color:var(--sj-rose)] mb-1">Как это работает?</div>
                  Не пропускай ни дня активности! Если серия больше 3 дней, ты получаешь <span class="text-emerald-400 font-bold">+5% коинов</span> за все действия.
              </div>
          </div>
       </div>

       <div class="relative z-10 p-6 text-center flex flex-col items-center justify-center h-full">
         <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-rose-500/20 to-orange-500/20 border border-rose-500/30 flex items-center justify-center mb-3 shadow-[0_0_20px_rgba(244,63,94,0.2)] group-hover:scale-110 transition-transform duration-500">
           <i class="fa-solid fa-fire text-3xl text-[color:var(--sj-rose)] animate-pulse"></i>
         </div>
         <div class="text-4xl font-black text-white mb-1">
           <span x-text="stats.streak">0</span> дней
         </div>
         <div class="text-xs font-bold uppercase tracking-widest text-[color:var(--sj-muted)]">Серия побед</div>

         <div x-show="stats.streak > 3" class="mt-2 px-2 py-0.5 rounded-lg bg-emerald-500/20 border border-emerald-500/30 text-[10px] text-emerald-400 font-bold">
             +5% БОНУС АКТИВЕН
         </div>
       </div>
    </div>
  </div>

  <div x-show="currentBuff" x-transition class="mb-10">
      <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
         <i class="fa-solid fa-chess-knight text-violet-400"></i> Активная стратегия
         <div class="relative group/info ml-2">
             <i class="fa-solid fa-info-circle text-xs text-white/30 hover:text-white cursor-help"></i>
             <div class="absolute bottom-full left-0 mb-2 w-64 p-3 bg-[#101524] border border-white/20 rounded-xl text-xs text-white shadow-xl opacity-0 group-hover/info:opacity-100 pointer-events-none transition-opacity z-50">
                 Действует до полуночи. Множители (x1.5, x0.5) применяются автоматически при получении данных из AmoCRM.
             </div>
         </div>
      </h2>
      <div class="p-6 rounded-3xl border border-yellow-500/30 bg-yellow-500/5 relative overflow-hidden flex items-center gap-6">
          <div class="w-16 h-16 rounded-2xl bg-yellow-500/20 flex items-center justify-center text-3xl">
              <i class="fa-solid fa-shark text-yellow-400" x-show="currentBuff === 'SHARK'"></i>
              <i class="fa-solid fa-hammer text-yellow-400" x-show="currentBuff === 'WOODPECKER'"></i>
              <i class="fa-solid fa-yin-yang text-yellow-400" x-show="currentBuff === 'ZEN'"></i>
          </div>
          <div>
              <div class="text-yellow-400 font-bold text-lg tracking-wide" x-text="currentBuff"></div>
              <div class="text-white/60 text-sm">Ваши бонусы активны до конца дня.</div>
          </div>
      </div>
  </div>

  <div x-show="!loading && currentBuff === null"
       x-transition.opacity.duration.500ms
       class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#070b16]/95 backdrop-blur-md" style="display: none;">

       <div class="w-full max-w-5xl animate-bounce-in">
           <div class="text-center mb-8 relative">
               <h1 class="text-3xl md:text-5xl font-black text-white mb-3">Выберите стратегию</h1>
               <p class="text-lg text-[color:var(--sj-muted)] flex items-center justify-center gap-2">
                   Как вы планируете побеждать сегодня?
                   <span class="group relative cursor-help">
                       <i class="fa-regular fa-circle-question text-white/40 hover:text-white/80 text-sm"></i>
                       <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-[#101524] border border-white/10 rounded-xl text-xs text-left text-[color:var(--sj-muted)] shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-[110]">
                           <strong class="text-white block mb-1">Ежедневный ритуал</strong>
                           Стратегия действует до 00:00. Она умножает баллы за одни действия и уменьшает за другие. Выбирайте с умом, исходя из планов на день!
                       </span>
                   </span>
               </p>
           </div>

           <div class="grid lg:grid-cols-3 gap-6">
                <button @click="chooseBuff('SHARK')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-indigo-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-indigo-500/20 flex items-center justify-center mb-4 text-3xl text-indigo-400">
                        <i class="fa-solid fa-shark"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Акула</h3>
                    <p class="text-indigo-200/60 text-sm mb-4">Охота на крупную добычу.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">Продажи</span> <span class="text-emerald-400 font-bold">x1.5</span></div>
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">Звонки</span> <span class="text-rose-400 font-bold">x0.5</span></div>
                    </div>
                </button>

                <button @click="chooseBuff('WOODPECKER')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-rose-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-rose-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-rose-500/20 flex items-center justify-center mb-4 text-3xl text-rose-400">
                        <i class="fa-solid fa-hammer"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Дятел</h3>
                    <p class="text-rose-200/60 text-sm mb-4">Упорство и количество.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">Звонки</span> <span class="text-emerald-400 font-bold">x1.5</span></div>
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">Продажи</span> <span class="text-rose-400 font-bold">x0.5</span></div>
                    </div>
                </button>

                <button @click="chooseBuff('ZEN')" class="relative group text-left rounded-3xl border border-white/10 bg-[#101524] p-6 hover:border-emerald-500 hover:scale-105 transition-all duration-300 shadow-2xl">
                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    <div class="w-16 h-16 rounded-2xl bg-emerald-500/20 flex items-center justify-center mb-4 text-3xl text-emerald-400">
                        <i class="fa-solid fa-yin-yang"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Дзен</h3>
                    <p class="text-emerald-200/60 text-sm mb-4">Баланс и спокойствие.</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between p-2 rounded bg-black/40"><span class="text-white/70">Все действия</span> <span class="text-white font-bold">x1.0</span></div>
                        <div class="p-2 opacity-0">Spacer</div>
                    </div>
                </button>
           </div>
       </div>
  </div>

  <div x-show="loading"
       x-transition.opacity
       class="absolute inset-0 bg-[#070b16]/50 backdrop-blur-sm z-50 flex items-center justify-center rounded-3xl" style="display: none;">
    <div class="flex flex-col items-center">
      <i class="fa-solid fa-circle-notch fa-spin text-4xl text-[color:var(--sj-primary)]"></i>
      <span class="mt-2 text-sm font-semibold text-white">Применяем стратегию...</span>
    </div>
  </div>

  <div class="mt-16 max-w-4xl mx-auto px-4">
      <style>
          .feed-timeline { position: relative; padding-left: 2.5rem; }
          .feed-timeline::before { content: ''; position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--sj-primary) 0%, transparent 100%); opacity: 0.15; }
          .feed-node { position: absolute; left: 0.15rem; width: 1.25rem; height: 1.25rem; background: #0f121d; border: 3px solid var(--sj-primary); border-radius: 50%; z-index: 10; margin-top: 1.5rem; box-shadow: 0 0 15px var(--sj-primary); }
          .smart-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 30px; backdrop-filter: blur(12px); overflow: hidden; transition: all 0.3s; margin-bottom: 2.5rem; }
          .record-badge { background: linear-gradient(90deg, rgba(34,211,238,0.1) 0%, transparent 100%); border: 1px solid rgba(34,211,238,0.2); border-radius: 20px; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
          .smart-img { width: 100%; max-height: 500px; object-fit: cover; margin-top: 1rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: block; }
      </style>

      <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-black text-white tracking-tight flex items-center gap-3">
             <i class="fa-solid fa-fire-pulse text-amber-500"></i> Жизнь компании
          </h2>
          <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/30">Live Updates</span>
      </div>

      <div class="feed-timeline">
          <template x-for="item in feedItems" :key="item.id">
              <div class="relative">
                  <div class="feed-node"></div>

                  <template x-if="item.type === 'system'">
                      <div class="record-badge">
                          <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center text-cyan-400 border border-cyan-500/30">
                              <i class="fa-solid fa-trophy"></i>
                          </div>
                          <div class="flex-1 min-w-0">
                              <p class="font-bold text-sm text-white/90" x-text="item.message"></p>
                              <div class="text-[9px] text-white/30 font-black uppercase mt-1" x-text="formatDate(item.created_at)"></div>
                          </div>
                      </div>
                  </template>

                  <template x-if="item.type === 'post'">
                      <div class="smart-card">
                          <div class="p-6">
                              <div class="flex items-center justify-between mb-4">
                                  <div class="flex items-center gap-3">
                                      <div class="w-10 h-10 rounded-xl bg-violet-600 flex items-center justify-center text-black font-black" x-text="item.author[0].toUpperCase()"></div>
                                      <div>
                                          <div class="font-black text-sm text-white" x-text="item.author"></div>
                                          <div class="text-[10px] text-white/40" x-text="formatDate(item.created_at)"></div>
                                      </div>
                                  </div>
                              </div>
                              <div class="text-white/80 leading-relaxed" x-text="item.content"></div>

                              <template x-if="item.image_url && item.image_url !== ''">
                                  <div class="mt-4 rounded-2xl overflow-hidden bg-black/40 border border-white/5">
                                      <img :src="item.image_url"
                                           class="smart-img"
                                           loading="lazy"
                                           @error="console.log('Image failed:', item.image_url)">
                                  </div>
                              </template>
                          </div>

                          <div class="px-6 py-4 flex items-center gap-6 bg-white/5 border-t border-white/5">
                              <button @click="likePost(item)" class="flex items-center gap-2 text-sm font-bold transition-colors" :class="item.is_liked ? 'text-rose-500' : 'text-white/40 hover:text-white'">
                                  <i :class="item.is_liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                                  <span x-text="item.likes_count"></span>
                              </button>
                              <button @click="item.open = !item.open" class="flex items-center gap-2 text-white/40 hover:text-white text-sm font-bold transition-colors">
                                  <i class="fa-regular fa-comment"></i>
                                  <span x-text="item.comments.length"></span>
                              </button>
                          </div>

                          <div x-show="item.open" x-transition class="bg-black/20 p-6 border-t border-white/5">
                              <div class="space-y-4 mb-4">
                                  <template x-for="c in item.comments">
                                      <div class="flex gap-3 text-xs">
                                          <div class="font-black text-violet-400" x-text="c.username + ':'"></div>
                                          <div class="text-white/70" x-text="c.text"></div>
                                      </div>
                                  </template>
                              </div>
                              <input x-model="item.tempComm" @keyup.enter="sendComment(item)" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-xs text-white focus:outline-none focus:border-violet-500/50" placeholder="Ваш ответ...">
                          </div>
                      </div>
                  </template>
              </div>
          </template>
      </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function gameDashboard() {
    return {
      // Состояние пользователя и профиля
      userId: {{ current_user.id }},
      userHasAvatar: {{ 'true' if current_user.avatar_data else 'false' }},
      userRoleLabel: "{{ current_user.role.value }}",
      showProfileModal: false,
      isSavingProfile: false,
      editName: "{{ current_user.username or '' }}",
      avatarFile: null,

      // Состояние игры
      loading: false,
      currentBuff: null,
      stats: {
        username: "{{ current_user.username or 'Сотрудник' }}",
        coins: {{ user.gamification_profile.coins or 0 }},
        xp: {{ user.gamification_profile.xp or 0 }},
        streak: {{ user.gamification_profile.current_streak or 0 }},
        level: {{ (user.gamification_profile.xp // 1000) + 1 }},
        squad: null
      },

      onAvatarSelect(e) {
          this.avatarFile = e.target.files[0];
      },

      async saveProfile() {
          this.isSavingProfile = true;
          const fd = new FormData();
          fd.append('username', this.editName);
          if (this.avatarFile) fd.append('avatar', this.avatarFile);

          try {
              const r = await fetch('/api/user/profile/update', { method: 'POST', body: fd });
              if (r.ok) {
                  this.stats.username = this.editName;
                  if (this.avatarFile) {
                      // Принудительно обновляем страницу для сброса кеша картинок
                      location.reload();
                  } else {
                      this.showProfileModal = false;
                      Alpine.store('toasts').push({title:'Успешно', text:'Профиль обновлен', tone:'ok'});
                  }
              }
          } catch(e) {
              console.error(e);
          } finally {
              this.isSavingProfile = false;
          }
      },

      // Состояние AmoCRM
      amoLinked: {{ 'true' if is_amo_linked else 'false' }},
      amoLoading: false,
      amoStats: {
          calls: {{ amo_stat.calls_count or 0 }},
          minutes: {{ amo_stat.minutes_talked or 0 }},
          conversion: {{ amo_stat.conversion or 0 }}
      },
      amoStatusText: '{% if amo_stat.updated_at %}<i class="far fa-clock me-1"></i>Обновлено: {{ amo_stat.updated_at.strftime('%H:%M') }}{% else %}Данные не загружены{% endif %}',

      initDashboard() {
        this.fetchStatus();
        this.loadFeed(); // Загрузка ленты
        this.loadStories(); // Загрузка сторис
        if (this.amoLinked) {
            this.syncAmoStats();
        }

        // Слушаем обновления через сокеты
        const s = io();
        s.on('new_feed_item', () => {
             this.loadFeed();
        });
      },

      // --- Сторис ---
      stories: [],
      activeStory: null,
      async loadStories() {
          try {
              const r = await fetch('/api/feed/stories');
              if (r.ok) this.stories = await r.json();
          } catch(e) { console.error("Stories error", e); }
      },

      // --- Лента ---
      feedItems: [],
      async loadFeed() {
          try {
              const r = await fetch('/api/feed/list');
              if (!r.ok) return;
              const data = await r.json();

              // Превращаем данные в реактивный список для Alpine
              this.feedItems = data.map(x => ({
                  ...x,
                  open: false,
                  tempComm: '',
                  // Гарантируем наличие массива комментариев даже для системных событий
                  comments: x.comments || []
              }));
          } catch(e) {
              console.error("Feed error", e);
          }
      },
      async likePost(i) {
          const r = await fetch(`/api/feed/post/${i.id}/like`, {method: 'POST'});
          const d = await r.json();
          i.is_liked = d.status === 'liked';
          i.likes_count += (i.is_liked ? 1 : -1);
      },

      async sendComment(i) {
          if(!i.tempComm) return;
          const r = await fetch(`/api/feed/post/${i.id}/comment`, {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({text: i.tempComm})
          });
          const d = await r.json();
          i.comments.push({username: d.username, text: i.tempComm});
          i.tempComm = '';
      },

      formatDate(s) { return new Date(s).toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'}); },

      forceRefresh() {
          this.fetchStatus();
          if(this.amoLinked) this.syncAmoStats();
      },

      // --- Логика игры ---
      async fetchStatus() {
        try {
          const res = await fetch('/api/game/status');
          if (res.ok) {
            const data = await res.json();
            this.stats.coins = data.coins;
            this.stats.xp = data.xp;
            this.stats.streak = data.streak;
            this.stats.level = data.level;
            this.stats.squad = data.squad;
            this.currentBuff = data.today_buff;
          }
        } catch (e) {
          console.error("Failed to fetch status", e);
        }
      },

      async chooseBuff(type) {
        if (this.currentBuff) return;
        this.loading = true;
        try {
          const response = await fetch('/api/game/buff/choose', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ buff_type: type })
          });
          const result = await response.json();

          if (response.ok) {
            this.currentBuff = type;
            Alpine.store('toasts').push({
              title: 'Стратегия активирована!',
              text: result.message,
              tone: 'ok',
              icon: 'fa-solid fa-check-double'
            });
            if (result.streak !== undefined) this.stats.streak = result.streak;
          } else {
            Alpine.store('toasts').push({title: 'Ошибка', text: result.error, tone: 'err'});
          }
        } catch (e) {
          Alpine.store('toasts').push({title: 'Ошибка сети', text: 'Нет соединения', tone: 'err'});
        } finally {
            this.loading = false;
        }
      },

      // --- Логика AmoCRM ---
      async syncAmoStats() {
          this.amoLoading = true;
          this.amoStatusText = '<i class="fas fa-sync fa-spin me-1"></i>Обновление...';

          try {
              const response = await fetch('/api/partners/company/my/sync_stats', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'}
              });
              const data = await response.json();

              if (data.linked) {
                  // Плавная анимация чисел
                  this.animateValue('calls', this.amoStats.calls, data.calls);
                  this.animateValue('minutes', this.amoStats.minutes, data.minutes);
                  this.animateValue('conversion', this.amoStats.conversion, data.conversion);

                  this.amoStatusText = '<i class="fas fa-check-circle me-1"></i>Обновлено: только что';
              }
          } catch (error) {
              console.error('Ошибка AmoCRM:', error);
              this.amoStatusText = 'Ошибка обновления';
          } finally {
              this.amoLoading = false;
          }
      },

      animateValue(key, start, end) {
          if (start === end) return;
          let current = start;
          const step = (end - start) / 20; // 20 шагов анимации
          const timer = setInterval(() => {
              current += step;
              if ((step > 0 && current >= end) || (step < 0 && current <= end)) {
                  this.amoStats[key] = end;
                  clearInterval(timer);
              } else {
                  // Округляем до 1 знака для дробных или до целого
                  this.amoStats[key] = Number.isInteger(end) ? Math.round(current) : parseFloat(current.toFixed(1));
              }
          }, 30);
      }
    }
  }
</script>
{% endblock %}